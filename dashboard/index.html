<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentMesh Dashboard</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent), var(--accent-green));
            border-radius: 8px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-online {
            background: rgba(63, 185, 80, 0.2);
            color: var(--accent-green);
        }

        .status-offline {
            background: rgba(248, 81, 73, 0.2);
            color: var(--accent-red);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 16px;
            color: var(--text-secondary);
        }

        .card-value {
            font-size: 36px;
            font-weight: 600;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 14px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        .tier-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .tier-1 { background: rgba(88, 166, 255, 0.2); color: var(--accent); }
        .tier-1-5 { background: rgba(210, 153, 34, 0.2); color: var(--accent-yellow); }
        .tier-2 { background: rgba(139, 148, 158, 0.2); color: var(--text-secondary); }

        .action-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--bg-primary);
            border-color: var(--accent);
        }

        .action-btn.danger {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .action-btn.danger:hover {
            background: rgba(248, 81, 73, 0.2);
        }

        .policy-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .policy-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .policy-label {
            color: var(--text-secondary);
        }

        .policy-value {
            font-weight: 500;
        }

        .toggle {
            width: 48px;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active {
            background: var(--accent-green);
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle.active::after {
            transform: translateX(24px);
        }

        .log-entry {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 16px;
            font-family: monospace;
            font-size: 13px;
        }

        .log-time {
            color: var(--text-secondary);
            min-width: 90px;
        }

        .log-event {
            color: var(--accent);
            min-width: 120px;
        }

        .log-data {
            color: var(--text-primary);
        }

        .circuit-breakers {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .breaker-btn {
            padding: 10px 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .breaker-btn:hover {
            background: var(--bg-tertiary);
        }

        .breaker-btn.active {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .breaker-btn.emergency {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .breaker-btn.emergency:hover {
            background: rgba(248, 81, 73, 0.2);
        }

        @media (max-width: 768px) {
            .stat-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .policy-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <div class="logo"></div>
                AgentMesh Dashboard
            </h1>
            <span id="connection-status" class="status-badge status-offline">Disconnected</span>
        </header>

        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-label">Your AMID</div>
                <div class="stat-value" id="amid" style="font-size: 14px; word-break: break-all;">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Sessions</div>
                <div class="stat-value" id="active-sessions">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Messages Today</div>
                <div class="stat-value" id="messages-today">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Reputation Score</div>
                <div class="stat-value" id="reputation">0.50</div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Circuit Breakers</h2>
            </div>
            <div class="circuit-breakers">
                <button class="breaker-btn" onclick="pauseNew()">Pause New Connections</button>
                <button class="breaker-btn" onclick="resumeNew()">Resume Connections</button>
                <button class="breaker-btn emergency" onclick="emergencyStop()">Emergency Stop</button>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Active Sessions</h2>
            </div>
            <table id="sessions-table">
                <thead>
                    <tr>
                        <th>Session ID</th>
                        <th>Peer</th>
                        <th>Intent</th>
                        <th>Started</th>
                        <th>Messages</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sessions-body">
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--text-secondary);">No active sessions</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Recent Activity</h2>
            </div>
            <div class="card" id="activity-log" style="max-height: 400px; overflow-y: auto;">
                <div class="log-entry">
                    <span class="log-time">--:--:--</span>
                    <span class="log-event">waiting</span>
                    <span class="log-data">Loading activity log...</span>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Security Policy</h2>
                <button class="action-btn" onclick="editPolicy()">Edit Policy</button>
            </div>
            <div class="policy-grid">
                <div class="policy-item">
                    <span class="policy-label">Minimum Trust Tier</span>
                    <span class="policy-value" id="policy-tier">Tier 2</span>
                </div>
                <div class="policy-item">
                    <span class="policy-label">Minimum Reputation</span>
                    <span class="policy-value" id="policy-reputation">0.30</span>
                </div>
                <div class="policy-item">
                    <span class="policy-label">Strict Mode</span>
                    <div class="toggle" id="policy-strict" onclick="toggleStrict()"></div>
                </div>
                <div class="policy-item">
                    <span class="policy-label">Store Transcripts</span>
                    <div class="toggle active" id="policy-transcripts" onclick="toggleTranscripts()"></div>
                </div>
                <div class="policy-item">
                    <span class="policy-label">Max Concurrent Sessions</span>
                    <span class="policy-value" id="policy-max-sessions">10</span>
                </div>
                <div class="policy-item">
                    <span class="policy-label">Rate Limit (knocks/min)</span>
                    <span class="policy-value" id="policy-rate-limit">30</span>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <h2 class="section-title">KNOCK History</h2>
            </div>
            <table id="knocks-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>From</th>
                        <th>Tier</th>
                        <th>Intent</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody id="knocks-body">
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--text-secondary);">No KNOCK history</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Dashboard state
        let state = {
            connected: false,
            amid: '',
            sessions: [],
            policy: {},
            logs: []
        };

        // API base URL
        const API_BASE = 'http://localhost:7777/api';

        // Fetch and update dashboard
        async function refresh() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();

                state = { ...state, ...data };
                updateUI();
            } catch (e) {
                console.error('Failed to fetch status:', e);
            }
        }

        function updateUI() {
            // Connection status
            const statusEl = document.getElementById('connection-status');
            if (state.connected) {
                statusEl.textContent = 'Connected';
                statusEl.className = 'status-badge status-online';
            } else {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'status-badge status-offline';
            }

            // AMID
            document.getElementById('amid').textContent = state.amid || 'Not registered';

            // Stats
            document.getElementById('active-sessions').textContent = state.sessions?.length || 0;
            document.getElementById('messages-today').textContent = state.messagesT || 0;
            document.getElementById('reputation').textContent = (state.reputation || 0.5).toFixed(2);

            // Sessions table
            updateSessionsTable();

            // Activity log
            updateActivityLog();

            // Policy
            updatePolicy();
        }

        function updateSessionsTable() {
            const tbody = document.getElementById('sessions-body');

            if (!state.sessions || state.sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No active sessions</td></tr>';
                return;
            }

            tbody.innerHTML = state.sessions.map(s => `
                <tr>
                    <td style="font-family: monospace; font-size: 12px;">${s.id.substring(0, 8)}...</td>
                    <td style="font-family: monospace; font-size: 12px;">${s.peer.substring(0, 12)}...</td>
                    <td>${s.intent || '-'}</td>
                    <td>${formatTime(s.started)}</td>
                    <td>${s.messages || 0}</td>
                    <td>
                        <button class="action-btn danger" onclick="killSession('${s.id}')">Kill</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateActivityLog() {
            const logEl = document.getElementById('activity-log');

            if (!state.logs || state.logs.length === 0) {
                logEl.innerHTML = '<div class="log-entry"><span class="log-time">--:--:--</span><span class="log-event">idle</span><span class="log-data">No recent activity</span></div>';
                return;
            }

            logEl.innerHTML = state.logs.slice(-20).reverse().map(log => `
                <div class="log-entry">
                    <span class="log-time">${formatTime(log.ts)}</span>
                    <span class="log-event">${log.event}</span>
                    <span class="log-data">${JSON.stringify(log.data || {})}</span>
                </div>
            `).join('');
        }

        function updatePolicy() {
            if (!state.policy) return;

            const tiers = state.policy.accept_tiers || [2];
            const minTier = Math.min(...tiers);
            document.getElementById('policy-tier').textContent = `Tier ${minTier}`;

            document.getElementById('policy-reputation').textContent = (state.policy.min_reputation || 0.3).toFixed(2);
            document.getElementById('policy-max-sessions').textContent = state.policy.max_concurrent_sessions || 10;
            document.getElementById('policy-rate-limit').textContent = state.policy.rate_limit?.knocks_per_minute || 30;

            const strictEl = document.getElementById('policy-strict');
            strictEl.className = state.policy.strict_mode ? 'toggle active' : 'toggle';

            const transcriptsEl = document.getElementById('policy-transcripts');
            transcriptsEl.className = state.policy.store_transcripts !== false ? 'toggle active' : 'toggle';
        }

        function formatTime(ts) {
            if (!ts) return '--:--:--';
            const d = new Date(ts);
            return d.toLocaleTimeString();
        }

        // Actions
        async function killSession(sessionId) {
            if (!confirm('Kill this session?')) return;

            try {
                await fetch(`${API_BASE}/sessions/${sessionId}/kill`, { method: 'POST' });
                refresh();
            } catch (e) {
                console.error('Failed to kill session:', e);
            }
        }

        async function pauseNew() {
            try {
                await fetch(`${API_BASE}/breaker/pause`, { method: 'POST' });
                alert('Paused new connections');
                refresh();
            } catch (e) {
                console.error('Failed to pause:', e);
            }
        }

        async function resumeNew() {
            try {
                await fetch(`${API_BASE}/breaker/resume`, { method: 'POST' });
                alert('Resumed connections');
                refresh();
            } catch (e) {
                console.error('Failed to resume:', e);
            }
        }

        async function emergencyStop() {
            if (!confirm('EMERGENCY STOP will disconnect from the network and close all sessions. Continue?')) return;

            try {
                await fetch(`${API_BASE}/breaker/emergency`, { method: 'POST' });
                alert('Emergency stop activated');
                refresh();
            } catch (e) {
                console.error('Failed to emergency stop:', e);
            }
        }

        function toggleStrict() {
            const el = document.getElementById('policy-strict');
            el.classList.toggle('active');
            // TODO: Save policy
        }

        function toggleTranscripts() {
            const el = document.getElementById('policy-transcripts');
            el.classList.toggle('active');
            // TODO: Save policy
        }

        function editPolicy() {
            alert('Policy editor coming soon');
        }

        // Load demo data for now
        function loadDemoData() {
            state = {
                connected: true,
                amid: '5Kd3NBxk8Yb2fJ9PmZ4qRw',
                sessions: [],
                messagesT: 0,
                reputation: 0.5,
                policy: {
                    accept_tiers: [1, 1.5, 2],
                    min_reputation: 0.3,
                    strict_mode: false,
                    store_transcripts: true,
                    max_concurrent_sessions: 10,
                    rate_limit: { knocks_per_minute: 30 }
                },
                logs: [
                    { ts: new Date().toISOString(), event: 'connected', data: { relay: 'relay.agentmesh.net' } }
                ]
            };
            updateUI();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDemoData();
            // Refresh every 5 seconds
            // setInterval(refresh, 5000);
        });
    </script>
</body>
</html>
